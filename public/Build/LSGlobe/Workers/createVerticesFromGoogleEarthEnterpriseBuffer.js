define(["./defaultValue-bcb5baf7","./DeveloperError-b273b01a","./Check-f9a1a1be","./Math-588d98f6","./Cartesian2-10213add","./Rectangle-de996bfb","./Transforms-2b063051","./Matrix4-c981b715","./RuntimeError-1b5fbc4d","./WebGLConstants-667a4a5e","./ComponentDatatype-ec1abf38","./when-ae2a7552","./buildModuleUrl-cd6b3599","./AttributeCompression-8a5fa32d","./IntersectionTests-cc1722b0","./Plane-bb97f210","./WebMercatorProjection-d1a748fe","./createTaskProcessorWorker","./EllipsoidTangentPlane-86347fa6","./OrientedBoundingBox-6de788ea","./TerrainEncoding-a5a06c70"],function(fe,e,t,Te,Ce,n,Me,ve,be,i,a,r,o,s,u,h,xe,c,Ne,Se,we){"use strict";var Pe=Uint16Array.BYTES_PER_ELEMENT,Be=Int32Array.BYTES_PER_ELEMENT,Re=Uint32Array.BYTES_PER_ELEMENT,ye=Float32Array.BYTES_PER_ELEMENT,Ae=Float64Array.BYTES_PER_ELEMENT;function _e(e,t,i){i=fe.defaultValue(i,Te.CesiumMath);for(var a=e.length,n=0;n<a;++n)if(i.equalsEpsilon(e[n],t,Te.CesiumMath.EPSILON12))return n;return-1}var We=new Ce.Cartographic,Fe=new Ce.Cartesian3,Oe=new Ce.Cartesian3,Ue=new Ce.Cartesian3,Ve=new ve.Matrix4;function Ye(e,t,i,a,n,r,o,s,u,h){for(var c=o.length,d=0;d<c;++d){var l=o[d],g=l.cartographic,m=l.index,p=e.length,I=g.longitude,E=g.latitude,E=Te.CesiumMath.clamp(E,-Te.CesiumMath.PI_OVER_TWO,Te.CesiumMath.PI_OVER_TWO),g=g.height-r.skirtHeight;r.hMin=Math.min(r.hMin,g),Ce.Cartographic.fromRadians(I,E,g,We),u&&(We.longitude+=s),u?d===c-1?We.latitude+=h:0===d&&(We.latitude-=h):We.latitude+=s;E=r.ellipsoid.cartographicToCartesian(We);e.push(E),t.push(g),i.push(Ce.Cartesian2.clone(i[m])),0<a.length&&a.push(a[m]),ve.Matrix4.multiplyByPoint(r.toENU,E,Fe);g=r.minimum,E=r.maximum;Ce.Cartesian3.minimumByComponent(Fe,g,g),Ce.Cartesian3.maximumByComponent(Fe,E,E);E=r.lastBorderPoint;fe.defined(E)&&(E=E.index,n.push(E,p-1,p,p,m,E)),r.lastBorderPoint=l}}return c(function(e,t){e.ellipsoid=n.Ellipsoid.clone(e.ellipsoid),e.rectangle=n.Rectangle.clone(e.rectangle);var i=function(e,t,i,a,n,r,o,s,u,h){var c,d,l,g,m;ce=fe.defined(a)?(c=a.west,d=a.south,l=a.east,g=a.north,m=a.width,a.height):(c=Te.CesiumMath.toRadians(n.west),d=Te.CesiumMath.toRadians(n.south),l=Te.CesiumMath.toRadians(n.east),g=Te.CesiumMath.toRadians(n.north),m=Te.CesiumMath.toRadians(a.width),Te.CesiumMath.toRadians(a.height));var p,I,E=[d,g],f=[c,l],T=Me.Transforms.eastNorthUpToFixedFrame(t,i),C=ve.Matrix4.inverseTransformation(T,Ve);s&&(p=xe.WebMercatorProjection.geodeticLatitudeToMercatorAngle(d),I=1/(xe.WebMercatorProjection.geodeticLatitudeToMercatorAngle(g)-p));var M=new DataView(e),v=Number.POSITIVE_INFINITY,b=Number.NEGATIVE_INFINITY,x=Oe;x.x=Number.POSITIVE_INFINITY,x.y=Number.POSITIVE_INFINITY,x.z=Number.POSITIVE_INFINITY;var N=Ue;N.x=Number.NEGATIVE_INFINITY,N.y=Number.NEGATIVE_INFINITY,N.z=Number.NEGATIVE_INFINITY;var S,w,P=0,B=0,R=0;for(w=0;w<4;++w){var y=P;S=M.getUint32(y,!0),y+=Re;var A=Te.CesiumMath.toRadians(180*M.getFloat64(y,!0));y+=Ae,-1===_e(f,A)&&f.push(A);A=Te.CesiumMath.toRadians(180*M.getFloat64(y,!0));y+=Ae,-1===_e(E,A)&&E.push(A),y+=2*Ae;A=M.getInt32(y,!0);y+=Be,B+=A,A=M.getInt32(y,!0),R+=3*A,P+=S+Re}var _=[],W=[],F=new Array(B),O=new Array(B),U=new Array(B),V=s?new Array(B):[],Y=new Array(R),k=[],H=[],L=[],D=[],G=0,j=0;for(w=P=0;w<4;++w){S=M.getUint32(P,!0);var z=P+=Re,q=Te.CesiumMath.toRadians(180*M.getFloat64(P,!0));P+=Ae;var J=Te.CesiumMath.toRadians(180*M.getFloat64(P,!0));P+=Ae;var K=Te.CesiumMath.toRadians(180*M.getFloat64(P,!0)),Q=.5*K;P+=Ae;var X=Te.CesiumMath.toRadians(180*M.getFloat64(P,!0)),Z=.5*X;P+=Ae;var $=M.getInt32(P,!0);P+=Be;var ee=M.getInt32(P,!0);P+=Be,P+=Be;for(var te=new Array($),ie=0;ie<$;++ie){var ae=q+M.getUint8(P++)*K;We.longitude=ae;var ne=J+M.getUint8(P++)*X;We.latitude=ne;var re=M.getFloat32(P,!0);if(P+=ye,0!==re&&re<h&&(re*=-Math.pow(2,u)),re*=6371010*r,We.height=re,-1!==_e(f,ae)||-1!==_e(E,ne)){var oe=_e(_,We,Ce.Cartographic);if(-1!==oe){te[ie]=W[oe];continue}_.push(Ce.Cartographic.clone(We)),W.push(G)}te[ie]=G,Math.abs(ae-c)<Q?k.push({index:G,cartographic:Ce.Cartographic.clone(We)}):Math.abs(ae-l)<Q?L.push({index:G,cartographic:Ce.Cartographic.clone(We)}):Math.abs(ne-d)<Z?H.push({index:G,cartographic:Ce.Cartographic.clone(We)}):Math.abs(ne-g)<Z&&D.push({index:G,cartographic:Ce.Cartographic.clone(We)}),v=Math.min(re,v),b=Math.max(re,b),U[G]=re;re=i.cartographicToCartesian(We);F[G]=re,s&&(V[G]=(xe.WebMercatorProjection.geodeticLatitudeToMercatorAngle(ne)-p)*I),ve.Matrix4.multiplyByPoint(C,re,Fe),Ce.Cartesian3.minimumByComponent(Fe,x,x),Ce.Cartesian3.maximumByComponent(Fe,N,N);ae=(ae-c)/(l-c);ae=Te.CesiumMath.clamp(ae,0,1);ne=(ne-d)/(g-d);ne=Te.CesiumMath.clamp(ne,0,1),O[G]=new Ce.Cartesian2(ae,ne),++G}for(var se=3*ee,ue=0;ue<se;++ue,++j)Y[j]=te[M.getUint16(P,!0)],P+=Pe;if(S!==P-z)throw new be.RuntimeError("Invalid terrain tile.")}F.length=G,O.length=G,U.length=G,s&&(V.length=G);var he=G,n=j,e={hMin:v,lastBorderPoint:void 0,skirtHeight:o,toENU:C,ellipsoid:i,minimum:x,maximum:N};k.sort(function(e,t){return t.cartographic.latitude-e.cartographic.latitude}),H.sort(function(e,t){return e.cartographic.longitude-t.cartographic.longitude}),L.sort(function(e,t){return e.cartographic.latitude-t.cartographic.latitude}),D.sort(function(e,t){return t.cartographic.longitude-e.cartographic.longitude});o=1e-5;{var ce;Ye(F,U,O,V,Y,e,k,-o*m,!0,-o*ce),Ye(F,U,O,V,Y,e,H,-o*ce,!1),Ye(F,U,O,V,Y,e,L,o*m,!0,o*ce),Ye(F,U,O,V,Y,e,D,o*ce,!1),0<k.length&&0<D.length&&(le=k[0].index,ge=D[D.length-1].index,ce=F.length-1,Y.push(ge,ce,he,he,le,ge))}B=F.length;var de,le=Me.BoundingSphere.fromPoints(F);fe.defined(a)&&(de=Se.OrientedBoundingBox.fromRectangle(a,v,b,i));for(var ge=new we.EllipsoidalOccluder(i).computeHorizonCullingPointPossiblyUnderEllipsoid(t,F,v),a=new Ne.AxisAlignedBoundingBox(x,N,t),me=new we.TerrainEncoding(a,e.hMin,b,T,!1,s),pe=new Float32Array(B*me.getStride()),Ie=0,Ee=0;Ee<B;++Ee)Ie=me.encode(pe,Ie,F[Ee],O[Ee],U[Ee],void 0,V[Ee]);t=k.map(function(e){return e.index}).reverse(),a=H.map(function(e){return e.index}).reverse(),e=L.map(function(e){return e.index}).reverse(),T=D.map(function(e){return e.index}).reverse();return a.unshift(e[e.length-1]),a.push(t[0]),T.unshift(t[t.length-1]),T.push(e[0]),{vertices:pe,indices:new Uint16Array(Y),maximumHeight:b,minimumHeight:v,encoding:me,boundingSphere3D:le,orientedBoundingBox:de,occludeePointInScaledSpace:ge,vertexCountWithoutSkirts:he,indexCountWithoutSkirts:n,westIndicesSouthToNorth:t,southIndicesEastToWest:a,eastIndicesNorthToSouth:e,northIndicesWestToEast:T}}(e.buffer,e.relativeToCenter,e.ellipsoid,e.rectangle,e.nativeRectangle,e.exaggeration,e.skirtHeight,e.includeWebMercatorT,e.negativeAltitudeExponentBias,e.negativeElevationThreshold),a=i.vertices;return t.push(a.buffer),e=i.indices,t.push(e.buffer),{vertices:a.buffer,indices:e.buffer,numberOfAttributes:i.encoding.getStride(),minimumHeight:i.minimumHeight,maximumHeight:i.maximumHeight,boundingSphere3D:i.boundingSphere3D,orientedBoundingBox:i.orientedBoundingBox,occludeePointInScaledSpace:i.occludeePointInScaledSpace,encoding:i.encoding,vertexCountWithoutSkirts:i.vertexCountWithoutSkirts,indexCountWithoutSkirts:i.indexCountWithoutSkirts,westIndicesSouthToNorth:i.westIndicesSouthToNorth,southIndicesEastToWest:i.southIndicesEastToWest,eastIndicesNorthToSouth:i.eastIndicesNorthToSouth,northIndicesWestToEast:i.northIndicesWestToEast}})});
